// !!! OLD routing scheme: calls from SIP                                                                                                                                                                                                   
context sip {   // catch all into new context with the purpose to enable special extensions                                                                                                                                                 
                                                                                                                                                                                                                                            
    h => {                                                                                                                                                                                                                                  
        NoOp(CHANNELS sip hang = ${CHANNEL} :: ${uniqueid}>${leg1}>${leg2}>${dnid});                                                                                                                                                        
        // StopMonitor();                                                                                                                                                                                                                   
        NoOp(maxx: адрес файла для записи ${mfile});                                                                                                                                                                                        
        // System(/usr/local/sbin/wav2mp3 ${mfile});                                                                                                                                                                                        
        // Set(CDR(pbxserver)=${FILTER(0-9a-zA-Z\.\-,${SHELL(hostname)})});                                                                                                                                                                 
        Set(CDR(pbxserver)=${PBXSERVER});                                                                                                                                                                                                   
        &Event(hang,${CONTEXT});                                                                                                                                                                                                            
        Hangup();                                                                                                                                                                                                                           
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    _. => {                                                                                                                                                                                                                                 
        NoOp(maxx: sip channel name: ${CHANNEL(name)} , callerid(num): ${CALLERID(num)} , peername: ${CHANNEL(peername)} , forwardername: ${FORWARDERNAME});                                                                                
        if ( "${CHANNEL(peername)}" == "" && "${FORWARDERNAME}" != "" && "${BIND}" != "" ) {                                                                                                                                                
            Set(SIPROOT=${CUT(FORWARDERNAME,/,3)});                                                                                                                                                                                         
            Set(SIPROOT=${CUT(SIPROOT,-,1)});                                                                                                                                                                                               
            Set(__TAG=${SIPROOT});                                                                                                                                                                                                          
            Set(__cid=${CUT(SIPROOT,+,2)});                                                                                                                                                                                                 
            Set(__dnid=${EXTEN});                                                                                                                                                                                                           
            NoOp(maxx: phone redirect detected, need to chanage siprt forwardername ${SIPROOT} cid ${cid});                                                                                                                                 
        } else {                                                                                                                                                                                                                            
            Set(SIPROOT=${CHANNEL(peername)});                                                                                                                                                                                              
            Set(__siporiginid=${CHANNEL(UniqueID)});                                                                                                                                                                                        
        }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
        // Wait(3);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                            
        siprt=;                                                                                                                                                                                                                             
        // Set(__mfile=); //for MonitorTo use                                                                                                                                                                                               
        // Set(HASH(siprt)=${ODBC_SIPRT(${CHANNEL(peername)})});                                                                                                                                                                            
                                                                                                                                                                                                                                            
        Set(HASH(siprt)=${ODBC_SIPRT(${SIPROOT})});                                                                                                                                                                                         
                                                                                                                                                                                                                                            
        // NoOp(${HASHKEYS(siprt)});                                                                                                                                                                                                        
        // NoOp(maxx: calleridnumber from rt table ${HASH(siprt,calleridnumber)});                                                                                                                                                          
                                                                                                                                                                                                                                            
        if ( "${HASH(siprt,callerid)}" != "" ) {                                                                                                                                                                                            
            Set(CALLERID(all)=${HASH(siprt,callerid)});                                                                                                                                                                                     
        }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
        //DumpChan();                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
        // Set(__extenmask=${HASH(siprt,calleridnumber)});                                                                                                                                                                                  
        Set(__extenmask=${CALLERID(num)});                                                                                                                                                                                                  
                                                                                                                                                                                                                                            
        NoOp(maxx: normalized  sip channel name: ${CHANNEL(name)} , callerid(num): ${CALLERID(num)} , peername: ${CHANNEL(peername)} , forwardername: ${FORWARDERNAME} , extenmask: ${extenmask});                                          
                                                                                                                                                                                                                                            
        // __n1  - question                                                                                                                                                                                                                 
        __n1 = ${CALLERID(num)};                                                                                                                                                                                                            
                                                                                                                                                                                                                                            
        NoOp(CHANNELS sip = ${CHANNEL} :: ${uniqueid}>${leg1}>${leg2}>${dnid});                                                                                                                                                             
                                                                                                                                                                                                                                            
        &call-entry(${CONTEXT});                                                                                                                                                                                                            

        // Leg definitions must be stored overall call processing!                                                                                                                                                                          
        if ( "${leg1}" = "" ) Set(__leg1=${CALLERID(num)});                                                                                                                                                                                 
        if ( "${leg2}" = "" ) Set(__leg2=${CALLERID(dnid)}); // In most cases, must be ${EXTEN} in entry context                                                                                                                            
        if ( "${leg2}" = "" ) Set(__leg2=${EXTEN}); // In most cases, must be ${EXTEN} in entry context                                                                                                                                     
        if ( "${uniqueid}"="") Set(__uniqueid=${CDR(uniqueid)});                                                                                                                                                                            
                                                                                                                                                                                                                                            
        Set(CHANNEL(accountcode)=${leg2});                                                                                                                                                                                                  
        Set(CDR(userfield)=${uniqueid}>${leg1}>${leg2}>ROOT);                                                                                                                                                                               
        Set(CHANNEL(amaflags)=billing);                                                                                                                                                                                                     
        //Set(CDR(pbxserver)=integra.obit.ru);                                                                                                                                                                                              
        //Set(CDR(pbxserver)=${FILTER(0-9a-zA-Z\.\-,${SHELL(hostname)})});                                                                                                                                                                  
        //Set(CDR(pbxserver)=${SHELL(hostname)});                                                                                                                                                                                           
        Set(CDR(pbxserver)=${PBXSERVER});                                                                                                                                                                                                   
        //NoOp(maxx: current instance is ${SHELL(hostname)});                                                                                                                                                                               
                                                                                                                                                                                                                                            
        if (${REGEX("^[*][*][0-9]" ${dnid})}=1) {                                                                                                                                                                                           
            //Set(SHARED(PICKUP,SIP/${dnid:2})=${cid});                                                                                                                                                                                     
            goto blf|${EXTEN:2}|1; // BLF pickup                                                                                                                                                                                            
        }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
        if ("${BLINDTRANSFER}"!="") goto transfer|${EXTEN}|1; // BLIND TRANSFER TRAP                                                                                                                                                        
        if ("${dnid}"="") { // TRANSFER TRAP                                                                                                                                                                                                
            Set(ALLOW_TRANSFER=${HASH(ext,FeatureTransfer)});                                                                                                                                                                               
            goto transfer|${EXTEN}|1;                                                                                                                                                                                                       
        }                                                                                                                                                                                                                                   
        if (${incoming}=1) {                                                                                                                                                                                                                
            goto incoming-call|s|1;                                                                                                                                                                                                         
        } else {                                                                                                                                                                                                                            
            Set(_PARENT=${cid});                                                                                                                                                                                                            
            Set(GROUP(O)=${cid});                                                                                                                                                                                                           
            //DumpChan();                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
            goto outgoing-call|s|1;                                                                                                                                                                                                         
        }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                            
    } // exten _.                                                                                                                                                                                                                           
} // context sip






//########################################################################################################################################################################
// CallEntry.ael ###############################################################################################################################################################
//########################################################################################################################################################################

// !!! OLD routing schema: common point for all calls                                                                                                                                                                                       
macro call-entry(from_context) {                            // Make some desitions upon new call                                                                                                                                            
    catch h { // whitout a catch, dialplan stops execution on hangup !!!                                                                                                                                                                    
        // Set(CDR(pbxserver)=${FILTER(0-9a-zA-Z\.\-,${SHELL(hostname)})});                                                                                                                                                                 
        Set(CDR(pbxserver)=${PBXSERVER});                                                                                                                                                                                                   
        hang=1;                                                                                                                                                                                                                             
        return;                                                                                                                                                                                                                             
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    NoOp(maxx call-entry 10: call from: ${from_context} , callerid(num): ${CALLERID(num)} , callerid(name): ${CALLERID(name)} to ${EXTEN} );                                                                                                
    // Set(CALLERID(name)=${FILTER(\x20-\x7E,${CALLERID(name)})});                                                                                                                                                                          
    // нужно убрать 0x22, 0x27(кавычки)                                                                                                                                                                                                     
    // NoOp(maxx call-entry 13: call after filter from ${from_context} callerid(num) ${CALLERID(num)} callerid(name) ${CALLERID(name)} to ${EXTEN});                                                                                        
    // DumpChan();                                                                                                                                                                                                                          
    // Wait(3);                                                                                                                                                                                                                             
                                                                                                                                                                                                                                            
    if ( "${cid}"=="" || "${ALTER_CID}"=="1" ) {                                                                                                                                                                                            
        Set(__cid=${FILTER(0-9+,${CALLERID(num)})});        // !!! TaxiTel dirty hack !!!                                                                                                                                                   
        // NoOp(maxx: call-entry 19: cid ${cid});                                                                                                                                                                                           
        if ( "${cid}"=="") Set(__cid=${FILTER(0-9+,${CALLERID(name)})});                                                                                                                                                                    
        if ( "${CALLERID(num)}"=="Anonymous" ) Set(__cid=Anonymous);                                                                                                                                                                        
    } else {                                                                                                                                                                                                                                
        Set(__cid=${cid});                                                                                                                                                                                                                  
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    // NoOp(maxx: call-entry 26: cid ${cid});                                                                                                                                                                                               
                                                                                                                                                                                                                                            
    if ( "${SHARED(cid)}"!="" ) {                           // ChannelRedirect hack                                                                                                                                                         
        Set(__cid=${SHARED(cid)});                                                                                                                                                                                                          
    } else {                                                                                                                                                                                                                                
        if ( "${cid}"=="" ) Set(__cid=${CALLERID(ani)});    // Last resort                                                                                                                                                                  
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    NoOp(maxx: call-entry 34: cid: ${cid} , dnid: ${dnid} , CALLERID(dnid): ${CALLERID(dnid)});                                                                                                                                             
                                                                                                                                                                                                                                            
    Set(CHANNEL(language)=${DEFAULT_LANG});                                                                                                                                                                                                 
                                                                                                                                                                                                                                            
    if ( "${dnid}"=="" ) {                                                                                                                                                                                                                  
        if ( "${CUT(CALLERID(dnid),*,2)}"!="" && "${CUT(CALLERID(dnid),*,1)}"!="" ) {                                                                                                                                                       
            NoOp(maxx: call-entry 40: blf call cut dnid to exten);                                                                                                                                                                          
            Set(__dnid=${CUT(CALLERID(dnid),*,2)});                                                                                                                                                                                         
        } else {                                                                                                                                                                                                                            
            Set(__dnid=${CALLERID(dnid)});                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    Set(from=${from_context});                                                                                                                                                                                                              
    //NoOp(maxx: call-entry 48: tag ${TAG});                                                                                                                                                                                                

    if ( "${BIND}"=="" ) {                                                                                                                                                                                                                  
        if ( "${TAG}"=="" ) {                                                                                                                                                                                                               
            Set(__TAG=${CHANNEL(peername)});                                                                                                                                                                                                
            Set(LOCAL(ext)=${CUT(TAG,+,2)});                                                                                                                                                                                                
            // NoOp(maxx: ext ${ext});                                                                                                                                                                                                      
            if ( "${ext}"!="" ) {                                                                                                                                                                                                           
                Set(__BIND=${CUT(TAG,+,1)});                                                                                                                                                                                                
                if ( "${TRUST_CID}"!="1" ) Set(__cid=${ext});                                                                                                                                                                               
            }                                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    NoOp(maxx: call-entry 62: ext: ${ext} , tag: ${TAG});                                                                                                                                                                                   
                                                                                                                                                                                                                                            
    if ( "${BIND}"=="" && "${CUT(cid,+,1)}"!="" && "${TRUST_CID}"=="1" ) {  // BIND in cid - hack                                                                                                                                           
        Set(__BIND=${CUT(cid,+,1)});                                                                                                                                                                                                        
        Set(__cid=${CUT(cid,+,2)});                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    if ( "${CUT(dnid,+,2)}"!="" && "${CUT(dnid,+,1)}"!="" ) { // Dial "BIND+dnid" - reject BIND                                                                                                                                             
    if ( "${BIND}"=="" ) Set(__BIND=${CUT(dnid,+,1)});                                                                                                                                                                                      
    if ( "${dnid:0:1}"=="!" ) Set(__BIND=${CUT(dnid:1,+,1)});                                                                                                                                                                               
        Set(__dnid=${CUT(dnid,+,2-9)});                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    if ( "${dnid}"=="!!" || "${dnid}"=="!!!" ) {  // Set "${leg2}"|"!${leg2}"                                                                                                                                                               
        Set(__dnid=${dnid:2}${leg2});                                                                                                                                                                                                       
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    //тут хня.                                                                                                                                                                                                                              
    // NoOp(maxx: call-entry, dump before odbc_exten);                                                                                                                                                                                      
    // NoOp(maxx: call-entry originated ${originated} from_context ${from_context} cid ${cid} guid ${CDR(guid)});                                                                                                                           
                                                                                                                                                                                                                                            
    if (${LEN(${CDR(guid)})}=0) {                                                                                                                                                                                                           
                                                                                                                                                                                                                                            
        if ("${originated}"="1" & "${from_context}"="originate") { //first leg of originated call                                                                                                                                           
            Set(CDR(guid)=${ODBC_GUID(${BIND},${dnid})});                                                                                                                                                                                   
        } else {                                                                                                                                                                                                                            
            NoOp(maxx: call-entry 88: this is not the first leg of originated call);                                                                                                                                                        
            Set(CDR(guid)=${ODBC_GUID(${BIND},${cid})});                                                                                                                                                                                    
        }                                                                                                                                                                                                                                   
        CELGenUserEvent(guid,${CDR(guid)});                                                                                                                                                                                                 
        }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
    //DumpChan();                                                                                                                                                                                                                           
                                                                                                                                                                                                                                            
    //if ("${incoming}"="1" || ("${originated}"="1" & "${from_context}"!="originate")) { // Incoming route must NOT depend from CID here!                                                                                                   
                                                                                                                                                                                                                                            
    if ("${incoming}"="1" || "${iax-in}"="1" || "${DISA}"="1") { // Incoming route must NOT depend from CID here!                                                                                                                           
        NoOp(maxx: call-entry: incoming or second leg of originated call);                                                                                                                                                                  
        Set(HASH(ext)=${ODBC_EXTEN(${dnid},${BIND})});                                                                                                                                                                                      
        //DumpChan();                                                                                                                                                                                                                       
        if ("${HASH(ext,Exten)}"="") Set(HASH(ext)=${ODBC_EXTEN(!${dnid},${BIND})});                                                                                                                                                        
    } else {                                                                                                                                                                                                                                
        NoOp(maxx: call-entry: outgoing call);                                                                                                                                                                                              
        Set(HASH(ext)=${ODBC_EXTEN(${cid},${BIND})});                                                                                                                                                                                       
        //DumpChan();                                                                                                                                                                                                                       
        if ("${HASH(ext,Exten)}"="") {                                                                                                                                                                                                      
            NoOp(maxx: call-entry: outgoing call, but HASH(ext,Exten) ${HASH(ext,Exten)});                                                                                                                                                  
            Set(HASH(ext)=${ODBC_EXTEN(!${cid},${BIND})});                                                                                                                                                                                  
        }
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    if ("${DISA}"="1" && "${HASH(ext,BIND)}"!="") {                                                                                                                                                                                         
        Set(__BIND=${HASH(ext,BIND)});                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    //if ("${HASH(ext,Exten)}"="") Set(HASH(ext)=${ODBC_EXTEN(!,${BIND})});                                                                                                                                                                 
    //if ("${BIND}"="") Set(__BIND=${HASH(ext,BIND)});  // Last resort: BIND from Exten.                                                                                                                                                    
                                                                                                                                                                                                                                            
    if ("${BIND}"="") {                                                                                                                                                                                                                     
        NoOp(maxx: call-entry: ODBC_EXTEN  BIND ${HASH(ext,BIND)} );                                                                                                                                                                        
        Set(__BIND=${HASH(ext,BIND)});  // Last resort: BIND from Exten                                                                                                                                                                     
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    //Wait(3);                                                                                                                                                                                                                              
    Set(CDR(x-domain)=${BIND});                                                                                                                                                                                                             
    Set(CHANNEL(userfield)=${BIND});                                                                                                                                                                                                        
                                                                                                                                                                                                                                            
    if (("${originated}"="") || ("${originated}"="1" & "${from_context}"="originate")) {                                                                                                                                                    
        Set(incoming=1); // By default, consider it is incoming call, but orginated are both outgoing                                                                                                                                       
    }                                                                                                                                                                                                                                       
    // NoOp(maxx: incoming -> 0 if: HASH(ext,Exten) "${HASH(ext,Exten)}" cid "${cid}" );                                                                                                                                                    
    // If Exten+Type matches cid, consider it is outgoing call                                                                                                                                                                              
    if ("${HASH(ext,Exten)}"="${cid}"|"${HASH(ext,Exten)}"="!${cid}") {                                                                                                                                                                     
        //NoOp(maxx: TOUPPER(HASH(ext,Type))  "${TOUPPER(${HASH(ext,Type):0:${LEN(${from})}})}" TOUPPER(from) "${TOUPPER(${from})}");                                                                                                       
        if ("${TOUPPER(${HASH(ext,Type):0:${LEN(${from})}})}"="${TOUPPER(${from})}") {                                                                                                                                                      
            Set(incoming=0);                                                                                                                                                                                                                
            Set(__URLa=${ODBC_URL(${FILTER(0-9,${cid})},${BIND})});                                                                                                                                                                         
            Set(__URLb=${ODBC_URL(${FILTER(0-9,${dnid})},${BIND})});                                                                                                                                                                        
            &Event(egress,${CONTEXT});                                                                                                                                                                                                      
            //выводим ивэнты туда, где уже сформирована дата!!!!!!!!!!!                                                                                                                                                                     
        }                                                                                                                                                                                                                                   
        } else {                                                                                                                                                                                                                            
            Set(__URLa=${ODBC_URL(${FILTER(0-9,${cid})},${BIND})});                                                                                                                                                                         
            Set(__URLb=${ODBC_URL(${FILTER(0-9,${dnid})},${BIND})});                                                                                                                                                                        
            &Event(ingress,${CONTEXT});                                                                                                                                                                                                     
            //выводим ивэнты туда, где уже сформирована дата!!!!!!!!!!!                                                                                                                                                                     
        }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                            
    if ("${HASH(ext,MOH)}"!="") {                                                                                                                                                                                                           
        Set(CHANNEL(musicclass)=${HASH(ext,MOH)});                                                                                                                                                                                          
    }                                                                                                                                                                                                                                       
    if ("${HASH(ext,MonitorTo)}"!="") {                                                                                                                                                                                                     
        Set(__MonitorTo=${HASH(ext,MonitorTo)});                                                                                                                                                                                            
    }                                                                                                                                                                                                                                       
    // NoOp(CIDX=${cid});                                                                                                                                                                                                                   
    //if (${REGEX("^495[0-9]{7}$" ${cid})}=1) {                                                                                                                                                                                             
                                                                                                                                                                                                                                            
    Set(__dnid=${STRREPLACE(dnid,%23,#)});  // Asterisk permanent regression patch                                                                                                                                                          
                                                                                                                                                                                                                                            
    if (${REGEX("^${HASH(ext,ExternPrefix)}[0-9]\{2,28\}$" ${dnid})}) {                                                                                                                                                                     
        NoOp(maxx: callentry: dnid ${dnid} on exten is prefixed with ExternPrefix, which is set in exten attributes);                                                                                                                       
        Set(unprefdnid=${dnid:${LEN(${HASH(ext,ExternPrefix)})}});                                                                                                                                                                          
        Set(citylenght=${MATH(10 - ${LEN(${HASH(ext,Region)})},i)});                                                                                                                                                                        
        if (${LEN(${unprefdnid})} < 11 && ${LEN(${unprefdnid})} > ${citylenght}) {                                                                                                                                                          
            NoOp(maxx: callentry: dialed number is less than federal and more than city, cutting last digits to number: ${unprefdnid}, it's length is ${LEN(${unprefdnid})}, but citylenght is ${citylenght});                              
            Set(unprefdnid=${unprefdnid:0:${citylenght}});                                                                                                                                                                                  
            //NoOp(maxx: callentry: corrected number is: ${unprefdnid}, it's length is ${LEN(${unprefdnid})});                                                                                                                              
        }                                                                                                                                                                                                                                   
        //if (${MATH(10 - ${LEN(${HASH(ext,Region)})},i)}=${LEN(${unprefdnid})} && ${LEN(${unprefdnid})} < 7) {                                                                                                                             
        if (${citylenght}=${LEN(${unprefdnid})} && ${LEN(${unprefdnid})} < 7) {                                                                                                                                                             
            NoOp(maxx: callentry end: this is countryside call, normalized dnid is 8${HASH(ext,Region)}${unprefdnid});                                                                                                                      
            Set(dnid=8${HASH(ext,Region)}${unprefdnid});                                                                                                                                                                                    
        } else {                                                                                                                                                                                                                            
            Set(dnid=${unprefdnid});                                                                                                                                                                                                        
        }                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                            
    //DumpChan();                                                                                                                                                                                                                           
                                                                                                                                                                                                                                            
    return;                                                                                                                                                                                                                                 
} // macro call-entry(from_context) 